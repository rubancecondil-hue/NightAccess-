<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Secure Redirect</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0a0a;
      color: #fff;
      overflow: hidden;
    }

    /* Animated Background */
    .bg-animation {
      position: fixed;
      width: 100%;
      height: 100%;
      z-index: 0;
    }

    .bg-animation::before {
      content: '';
      position: absolute;
      width: 200%;
      height: 200%;
      background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3), transparent 50%),
                  radial-gradient(circle at 80% 80%, rgba(255, 107, 107, 0.3), transparent 50%),
                  radial-gradient(circle at 40% 20%, rgba(72, 219, 251, 0.3), transparent 50%);
      animation: bgFloat 20s ease-in-out infinite;
    }

    @keyframes bgFloat {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(-5%, 5%) rotate(120deg); }
      66% { transform: translate(5%, -5%) rotate(240deg); }
    }

    /* Glass Container */
    .container {
      position: relative;
      z-index: 10;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 2rem;
    }

    .card {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      padding: 3rem;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      animation: cardSlideIn 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    @keyframes cardSlideIn {
      from {
        opacity: 0;
        transform: translateY(30px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* Logo Animation */
    .logo {
      width: 80px;
      height: 80px;
      margin: 0 auto 2rem;
      position: relative;
    }

    .logo svg {
      width: 100%;
      height: 100%;
      animation: rotateLogo 3s linear infinite;
    }

    @keyframes rotateLogo {
      to { transform: rotate(360deg); }
    }

    h1 {
      font-size: 2rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .subtitle {
      text-align: center;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 2rem;
      font-size: 0.95rem;
    }

    /* Progress Circle */
    .progress-container {
      position: relative;
      width: 200px;
      height: 200px;
      margin: 2rem auto;
    }

    .progress-ring {
      transform: rotate(-90deg);
    }

    .progress-ring-circle {
      transition: stroke-dashoffset 1s linear;
      stroke: url(#gradient);
      stroke-linecap: round;
    }

    #countdown-number {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 4rem;
      font-weight: 900;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    /* Stats */
    .stats {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 1rem;
      margin-top: 2rem;
    }

    .stat-item {
      text-align: center;
      padding: 1rem;
      background: rgba(255, 255, 255, 0.03);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: #667eea;
      display: block;
    }

    .stat-label {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 0.25rem;
    }

    /* Loading Animation */
    .loader {
      display: flex;
      gap: 0.5rem;
      justify-content: center;
      margin: 2rem 0;
    }

    .loader span {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      animation: bounce 1.4s infinite ease-in-out both;
    }

    .loader span:nth-child(1) { animation-delay: -0.32s; }
    .loader span:nth-child(2) { animation-delay: -0.16s; }

    @keyframes bounce {
      0%, 80%, 100% { transform: scale(0); opacity: 0.5; }
      40% { transform: scale(1); opacity: 1; }
    }

    /* Error State */
    .error {
      text-align: center;
      padding: 2rem;
    }

    .error-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
    }

    .error-title {
      font-size: 1.5rem;
      font-weight: 700;
      color: #ff6b6b;
      margin-bottom: 0.5rem;
    }

    .error-message {
      color: rgba(255, 255, 255, 0.6);
    }

    /* Button */
    .btn {
      display: inline-block;
      margin-top: 1.5rem;
      padding: 0.75rem 2rem;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 12px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    /* Security Badge */
    .security-badge {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 2rem;
      padding: 0.75rem;
      background: rgba(76, 175, 80, 0.1);
      border: 1px solid rgba(76, 175, 80, 0.3);
      border-radius: 8px;
      font-size: 0.85rem;
      color: #4caf50;
    }

    .hidden { display: none; }

    @media (max-width: 640px) {
      .card { padding: 2rem 1.5rem; }
      h1 { font-size: 1.5rem; }
      #countdown-number { font-size: 3rem; }
      .stats { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <div class="bg-animation"></div>
  
  <div class="container">
    <div class="card">
      <div class="logo">
        <svg viewBox="0 0 100 100" fill="none">
          <circle cx="50" cy="50" r="45" stroke="url(#gradient)" stroke-width="4"/>
          <path d="M50 20 L50 50 L70 50" stroke="url(#gradient)" stroke-width="4" stroke-linecap="round"/>
          <defs>
            <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
              <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
            </linearGradient>
          </defs>
        </svg>
      </div>

      <div id="loading-state">
        <h1>üîê Secure Redirect</h1>
        <p class="subtitle">Verifying and preparing your link...</p>
        <div class="loader">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>

      <div id="redirect-state" class="hidden">
        <h1>‚ú® Redirect Ready</h1>
        <p class="subtitle">Taking you to your destination securely</p>

        <div class="progress-container">
          <svg class="progress-ring" width="200" height="200">
            <defs>
              <linearGradient id="progressGradient">
                <stop offset="0%" stop-color="#667eea" />
                <stop offset="100%" stop-color="#764ba2" />
              </linearGradient>
            </defs>
            <circle
              class="progress-ring-circle"
              stroke="rgba(255,255,255,0.1)"
              stroke-width="8"
              fill="transparent"
              r="90"
              cx="100"
              cy="100"
            />
            <circle
              id="progress-circle"
              class="progress-ring-circle"
              stroke-width="8"
              fill="transparent"
              r="90"
              cx="100"
              cy="100"
              stroke-dasharray="565.48"
              stroke-dashoffset="565.48"
            />
          </svg>
          <div id="countdown-number">5</div>
        </div>

        <div class="stats">
          <div class="stat-item">
            <span class="stat-value" id="redirect-count">-</span>
            <span class="stat-label">Redirects</span>
          </div>
          <div class="stat-item">
            <span class="stat-value">‚úì</span>
            <span class="stat-label">Verified</span>
          </div>
          <div class="stat-item">
            <span class="stat-value" id="link-index">-</span>
            <span class="stat-label">Index</span>
          </div>
        </div>

        <div class="security-badge">
          <span>üîí</span>
          <span>Secure Connection Established</span>
        </div>
      </div>

      <div id="error-state" class="hidden">
        <div class="error">
          <div class="error-icon">‚ùå</div>
          <div class="error-title" id="error-title">Error</div>
          <p class="error-message" id="error-message">Something went wrong</p>
          <a href="/" class="btn">Go Home</a>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
      increment
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCo1c4PTw5vbDUqRZtTYgBsqSddPNUFKxc",
      authDomain: "nightaccess-login-d3b7e.firebaseapp.com",
      projectId: "nightaccess-login-d3b7e",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const linkId = new URLSearchParams(window.location.search).get("id");
    let targetURL = null;
    let redirectData = null;

    function showError(title, message) {
      document.getElementById('loading-state').classList.add('hidden');
      document.getElementById('redirect-state').classList.add('hidden');
      document.getElementById('error-state').classList.remove('hidden');
      document.getElementById('error-title').textContent = title;
      document.getElementById('error-message').textContent = message;
    }

    async function fetchRedirect() {
      if (!linkId) {
        showError('Invalid Link', 'No link ID provided in URL');
        return;
      }

      try {
        const ref = doc(db, "links", linkId);
        const snap = await getDoc(ref);

        if (!snap.exists()) {
          showError('Link Not Found', 'This redirect link does not exist or has been removed');
          return;
        }

        redirectData = snap.data();
        let index = redirectData.currentIndex || 0;

        targetURL = redirectData.redirects?.[index] || redirectData.finalLink || redirectData.originalLink;

        if (!targetURL) {
          showError('Configuration Error', 'No valid redirect URL found');
          return;
        }

        // Update stats
        await updateDoc(ref, {
          currentIndex: index + 1,
          totalClicks: increment(1),
          lastAccessed: new Date().toISOString()
        });

        // Show redirect UI
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('redirect-state').classList.remove('hidden');
        
        // Update stats display
        document.getElementById('redirect-count').textContent = redirectData.redirects?.length || 1;
        document.getElementById('link-index').textContent = index + 1;

        startCountdown();
      } catch (error) {
        console.error('Firebase Error:', error);
        showError('Connection Error', 'Failed to load redirect data. Please try again.');
      }
    }

    function startCountdown() {
      let seconds = 5;
      const countdownEl = document.getElementById('countdown-number');
      const progressCircle = document.getElementById('progress-circle');
      const circumference = 2 * Math.PI * 90;

      const timer = setInterval(() => {
        seconds--;
        countdownEl.textContent = seconds;
        
        const progress = ((5 - seconds) / 5) * circumference;
        progressCircle.style.strokeDashoffset = circumference - progress;

        if (seconds === 0) {
          clearInterval(timer);
          window.location.href = targetURL;
        }
      }, 1000);
    }

    // Initialize
    fetchRedirect();
  </script>
</body>
</html>
